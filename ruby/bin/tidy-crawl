#!/usr/bin/env ruby

$LOAD_PATH.unshift File.join(File.dirname(__FILE__), '..', 'lib')

require 'tidy'
require 'open-uri'

# Thanks, http://rhnh.net/2007/12/20/understanding-the-y-combinator
def y_combinator(&f)
  lambda {|x| x[x] } [
    lambda {|maker| lambda {|*args| f[maker[maker]][*args] }}
  ]
end

tidy = Tidy.new

y_combinator {|callback|
  lambda {|entry|

    uri = open(entry)
    errors, out = tidy.parse(uri.read)
    puts "URI: #{entry}"

    errors.each do |error|
      puts "  #{error}"
    end

    links = out.scan(/href=.([^'"]*)./).flatten

    links.each do |link|
      #callback.call(link)
    end
  }
}.call(ARGV[0])
